{% extends "base.html" %}

{% block content %}
<div class="search-section">
    <div class="logout-container">
        <a href="/logout" class="btn-logout">[ LOGOUT ] ◄</a>
    </div>
    
    {% if error %}
    <div class="error-message">
        <span class="error-icon">[ ! ]</span> ERROR: {{ error }}
    </div>
    {% endif %}
    
    <!-- Progress Bar Container (hidden by default) -->
    <div id="progress-container" class="progress-container" style="display: none;">
        <div class="progress-header">
            <span class="progress-icon">◢◣◤◥</span>
            <span class="progress-label">SEARCHING DATABASE...</span>
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
                <div class="progress-glitch"></div>
            </div>
        </div>
        <div class="progress-info">
            <span id="progress-text" class="progress-text">Initializing search threads...</span>
            <span id="progress-percent" class="progress-percent">0%</span>
        </div>
        <div class="progress-stats">
            <div class="stat-item">
                <span class="stat-label">THREADS:</span>
                <span class="stat-value">24 ACTIVE</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">STATUS:</span>
                <span id="scan-status" class="stat-value">PROCESSING</span>
            </div>
        </div>
    </div>

    <form method="POST" action="/" class="search-form" id="search-form">
        <div class="form-group">
            <label class="form-label">
                <span class="label-icon">►</span> SELECT TARGET TYPE:
            </label>
            <select name="search_type" class="form-select" required>
                <option value="" disabled selected>-- SELECT SEARCH TYPE --</option>
                <option value="name">[ NAME ] - Search by Full Name</option>
                <option value="fbid">[ FBID ] - Search by Facebook ID</option>
                <option value="phone">[ PHONE ] - Search by Phone Number</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <span class="label-icon">►</span> ENTER SEARCH QUERY:
            </label>
            <input 
                type="text" 
                name="search_term" 
                class="form-input" 
                placeholder="Type search term..."
                autocomplete="off"
                required
            >
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-submit" id="submit-btn">
                [ EXECUTE SEARCH ] ▶
            </button>
        </div>
    </form>
    
    {% if results is defined %}
    <!-- Search Results Section -->
    <div class="results-section">
        <div class="results-header">
            <div class="terminal-separator">
                ════════════════════════════════════════════════════════════════════════════════
            </div>
            <h2 class="results-title">[ SEARCH RESULTS ]</h2>
            <div class="results-meta">
                <span class="meta-item">
                    <span class="meta-icon">►</span> QUERY: <span class="text-highlight">{{ search_term }}</span>
                </span>
                <span class="meta-item">
                    <span class="meta-icon">►</span> TYPE: <span class="text-highlight">{{ search_type|upper }}</span>
                </span>
                <span class="meta-item">
                    <span class="meta-icon">►</span> FOUND: <span class="text-success">{{ total_results }}</span> RECORDS
                </span>
                <span class="meta-item">
                    <span class="meta-icon">►</span> TIME: <span class="text-success">{{ search_time_ms }}ms</span>
                </span>
            </div>
            <div class="terminal-separator">
                ════════════════════════════════════════════════════════════════════════════════
            </div>
        </div>

        {% if results %}
            {% for user in results %}
            <div class="user-card">
                <div class="user-header">
                    [ USER #{{ loop.index + ((page - 1) * 10) }} ]
                </div>
                <div class="user-details">
                    {% if user.first_name or user.last_name %}
                    <div class="detail-row">
                        <span class="detail-label">NAME:</span>
                        <span class="detail-value">{{ user.first_name }} {{ user.last_name }}</span>
                    </div>
                    {% endif %}

                    {% if user.email %}
                    <div class="detail-row">
                        <span class="detail-label">EMAIL:</span>
                        <span class="detail-value">{{ user.email }}</span>
                    </div>
                    {% endif %}

                    {% if user.phone %}
                    <div class="detail-row">
                        <span class="detail-label">PHONE:</span>
                        <span class="detail-value">{{ user.phone }}</span>
                    </div>
                    {% endif %}

                    {% if user.school %}
                    <div class="detail-row">
                        <span class="detail-label">SCHOOL:</span>
                        <span class="detail-value">{{ user.school }}</span>
                    </div>
                    {% endif %}

                    {% if user.location %}
                    <div class="detail-row">
                        <span class="detail-label">LOCATION:</span>
                        <span class="detail-value">{{ user.location }}</span>
                    </div>
                    {% endif %}

                    {% if user.gender %}
                    <div class="detail-row">
                        <span class="detail-label">GENDER:</span>
                        <span class="detail-value">{{ user.gender }}</span>
                    </div>
                    {% endif %}

                    {% if user.profile_url %}
                    <div class="detail-row">
                        <span class="detail-label">PROFILE:</span>
                        <span class="detail-value detail-link">
                            <a href="{{ user.profile_url }}" target="_blank">{{ user.profile_url }}</a>
                        </span>
                    </div>
                    {% endif %}

                    {% if user.fbid %}
                    <div class="detail-row">
                        <span class="detail-label">FBID:</span>
                        <span class="detail-value">{{ user.fbid }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Pagination Controls -->
            {% if total_pages > 1 %}
            <div class="pagination">
                <div class="pagination-info">
                    <span class="page-text">PAGE {{ page }} OF {{ total_pages }}</span>
                </div>
                <div class="pagination-controls">
                    {% if has_prev %}
                    <a href="/?search_type={{ search_type }}&search_term={{ search_term|urlencode }}&page={{ page - 1 }}" class="btn-page">
                        ◄ PREVIOUS
                    </a>
                    {% else %}
                    <span class="btn-page btn-disabled">◄ PREVIOUS</span>
                    {% endif %}

                    {% if has_next %}
                    <a href="/?search_type={{ search_type }}&search_term={{ search_term|urlencode }}&page={{ page + 1 }}" class="btn-page">
                        NEXT ►
                    </a>
                    {% else %}
                    <span class="btn-page btn-disabled">NEXT ►</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="no-results">
                <div class="no-results-icon">[ ✗ ]</div>
                <div class="no-results-text">NO RECORDS FOUND</div>
                <div class="no-results-hint">Try a different search term or search type</div>
            </div>
        {% endif %}

        <div class="back-link">
            <a href="/" class="btn-back">[ NEW SEARCH ] ◄</a>
        </div>
    </div>
    {% endif %}

    <script>
        document.getElementById('search-form').addEventListener('submit', function(e) {
            // Show progress bar
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('search-form').style.display = 'none';
            
            // Animate progress bar
            let progress = 0;
            const progressFill = document.getElementById('progress-fill');
            const progressPercent = document.getElementById('progress-percent');
            const progressText = document.getElementById('progress-text');
            const scanStatus = document.getElementById('scan-status');
            
            const messages = [
                'Searching...',
                'Searching...',
                'Searching...',
                'Searching...',
                'Searching...',
                'Searching...',
                'Searching...',
                'Finalizing...'
            ];
            
            let messageIndex = 0;
            
            const interval = setInterval(function() {
                if (progress < 90) {
                    // Slower, more realistic progress for large files
                    if (progress < 20) {
                        progress += Math.random() * 8 + 2;
                    } else if (progress < 50) {
                        progress += Math.random() * 5 + 1;
                    } else if (progress < 80) {
                        progress += Math.random() * 3 + 0.5;
                    } else {
                        progress += Math.random() * 1 + 0.2;
                    }
                    
                    if (progress > 90) progress = 90;
                    
                    progressFill.style.width = progress + '%';
                    progressPercent.textContent = Math.floor(progress) + '%';
                    
                    // Update message based on progress
                    if (progress > messageIndex * 12 && messageIndex < messages.length) {
                        progressText.textContent = messages[messageIndex];
                        messageIndex++;
                    }
                    
                    // Update scan status
                    if (progress < 20) {
                        scanStatus.textContent = 'LOADING';
                    } else if (progress < 85) {
                        scanStatus.textContent = 'SCANNING';
                    } else {
                        scanStatus.textContent = 'FINALIZING';
                    }
                }
            }, 300);  // Slower updates for more realistic feel
            
            // Extended timeout for large datasets
            setTimeout(function() {
                clearInterval(interval);
            }, 120000); // 2 minute safety timeout
        });
    </script>
    
    <!-- <div class="info-box">
        <div class="info-line">
            <span class="info-icon">◆</span> Database Status: <span class="text-success">ONLINE</span>
        </div>
        <div class="info-line">
            <span class="info-icon">◆</span> Total Records: <span class="text-highlight">~12GB</span>
        </div>
        <div class="info-line">
            <span class="info-icon">◆</span> Search Engine: <span class="text-highlight">MULTITHREADED</span>
        </div>
        <div class="info-line">
            <span class="info-icon">◆</span> Estimated Time: <span class="text-success">&lt; 10s</span>
        </div>
    </div> -->
</div>

<!-- <div class="terminal-separator">
    ════════════════════════════════════════════════════════════════════════════════
</div> -->

<!-- <div class="usage-guide">
    <div class="guide-title">[ USAGE INSTRUCTIONS ]</div>
    <pre class="guide-content">
    1. Select search type from dropdown menu
    2. Enter exact search term (case-sensitive)
    3. Click EXECUTE SEARCH to begin scanning
    4. Results will appear in &lt; 10 seconds
    
    WARNING: Unauthorized access is prohibited.
    All searches are logged and monitored.
    </pre>
</div> -->
{% endblock %}
